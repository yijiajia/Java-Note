Redis 缓存异常常见的问题有缓存雪崩、缓存击穿、缓存穿透。这三个问题一旦发生，请求量就会堆积到数据库层。如果请求的并发量大，那么就会导致数据库宕机或是故障。

## 缓存雪崩

缓存雪崩指的是，大量的应用请求无法在Redis缓存中处理，大量请求会发送到数据库层，导致数据库层的压力激增。

引发雪崩的原因有两个。

一是因为，缓存中有大量的缓存同时过期失效，导致大量请求无法得到处理；

还有是因为，Redis缓存实例发生故障宕机了，无法处理请求，大量请求就会发送到数据库层。

针对缓存同时失效的问题，有这样的解决方案。

一是尽量避免给大量的数据设置相同的过期时间，如果业务层上有要求某些数据同时失效，可以在设置过期时间时，给这个过期时间加上个较小的随机数，例如随机个1-3分钟。这样就不会有大量的数据同时过期失效，同时也保证了这些数据在相近的时间失效，仍然满足业务需求。

二是可以通过服务降级去应对缓存雪崩。针对不同的数据有不同的访问方式。

* 针对非核心数据，暂停从缓存中获取这些数据，而是直接返回预定义、空值或是错误信息；

* 针对核心数据，仍然走缓存，缓存找不到，继续通过数据库读取。

如果是因为实例发生宕机了，就需要依靠Redis缓存高可用集群了，通过发现节点宕机，将该节点切换为其它节点。



## 缓存击穿
缓存击穿指的是，针对某个访问非常频繁的热点数据的请求，无法在缓存中进行处理，访问该数据的请求就会发生给数据库层，导致数据库压力激增，会影响到数据库处理其他请求。

缓存击穿的情况，经常发生在热点数据过期失效时。

**解决方案**是，针对热点数据不设置过期时间，这样一来，热点数据就可以在缓存中处理，而不需要去数据库中获取了。


## 缓存穿透
缓存穿透指的是，访问的某个数据既不在缓存中也不在数据库中。这样的请求就会一直访问到数据库层。如果有大量的该数据请求进来，缓存就成了摆设，请求直接到了数据库，会影响到其它数据的访问。

发生缓存穿透的场景是，
* 恶意攻击，专门访问数据库中没有的数据；
* 业务请求的误操作，缓存和数据库中的数据都被误删除了，导致都没有数据；
* 新业务上线时，缓存和数据库都没有用户的业务数据；


针对缓存穿透的问题，可以通过以下的方式进行处理：
* **缓存空值或缺省值**。当查询的数据在缓存和数据库都没有数据时，可以在缓存中缓存一个空值或缺省值，防止不存在数据访问到了数据库层。当后续新增了该数据时，注意需要将该空值缓存给移除掉。
* **使用布隆过滤器**。利用布隆过滤器的特点可以校验数据是否存在，每新增一个数据时，在布隆过滤器做个标记。这样当缓存缺失时，就可以先通过布隆过滤器检测到该数据不存在，就不用再去数据库中访问了。布隆过滤器可以使用`Redis`实现。
* **前端拦截恶意请求**。当有恶意请求访问不存在的数据时，在前端针对请求的参数进行合法性检测，过滤请求参数不合理、参数非法值、字段不存在的恶意请求。不让它们访问数据库，这样就不会产生缓存穿透的问题了。

<img src="https://static001.geekbang.org/resource/image/b5/e1/b5bd931239be18bef24b2ef36c70e9e1.jpg"> 