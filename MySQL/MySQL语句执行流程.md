# MySQL语句的执行流程

MySQL 可以分为Server 层和存储引擎层两部分。



Server层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖了MySQL的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。

存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎。

<img src="https://z3.ax1x.com/2021/04/17/c4H2cQ.png">

## Server层

### 连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接。连接命令如下

```mysql
mysql -h$ip -P$port -u$user -p
```

客户端通过tcp握手与服务端建立连接。



### 查询缓存

MySQL 拿到查询语句后， 会先到查询缓存看看，之前是不是执行这条语句。之前执行过的语句及其结果可能会以Key-Value对的形式被直接缓存在内存中。如果命中缓存，mysql将直接返回结果,无需执行下面的操作。



可以将参数query_cache_type设置成DEMAND， 这样对于默认的查询SQL就不会查询缓存。 如需查询缓存，可以用SQL_CACHE显示指定。

```mysql
select SQL_CACHE * from T where ID=18;
```



注意，MySQL8.0 版本直接将查询缓存的整块功能删掉了。



### 分析器

分析器会针对SQL语句做"词法分析"，识别语句的关键字，及关键字后面的字符，如表名、字段名等。

词法分析完后，会去做语法分析，即检查语句是否符合MySQL的语法。



### 优化器

优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。



### 执行器

即执行SQL语句，会在执行前，先去获取连接客户对操作的表有没有相应的权限。有权限会打开表，根据表的引擎定义，去使用这个引擎提供的接口。



